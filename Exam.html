<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaterialX | Smart Student Organizer</title>
    <link rel="icon" type="image/png" href="img/photo_2024-11-16_17-45-40.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* CSS Variables & Reset */
        :root {
            --primary-blue: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-purple: #7209b7;
            --accent-teal: #4cc9f0;
            --success-green: #06d6a0;
            --warning-yellow: #ffd166;
            --danger-red: #ef476f;
            --light-bg: #f8f9fa;
            --card-bg: #ffffff;
            --dark-text: #2b2d42;
            --medium-text: #6c757d;
            --light-text: #adb5bd;
            --border-color: #e9ecef;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
            --radius: 12px;
            --transition: all 0.3s ease;
        }

        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark-text);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 2rem 1rem;
        }

        /* App Container */
        .app-container {
            width: 100%;
            max-width: 1400px;
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
            transition: var(--transition);
        }

        .app-container:hover {
            box-shadow: var(--shadow-hover);
        }

        /* View Management */
        .view {
            display: none;
            flex-direction: column;
            gap: 1.5rem;
            padding: 2rem;
            animation: fadeIn 0.5s ease;
        }

        .view.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Header Styles */
        header {
            text-align: center;
            position: relative;
            padding-bottom: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        header h1 {
            color: var(--primary-blue);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        header p {
            font-size: 1.2rem;
            color: var(--medium-text);
            font-weight: 400;
        }

        /* Improved Header with Back Button */
        .header-with-action {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            flex-wrap: wrap;
            gap: 1rem;
            position: relative;
        }

        .header-title-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .header-with-action h1 {
            margin: 0;
            text-align: left;
            font-size: 2rem;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Improved Back Button */
        .btn-back {
            background: var(--primary-blue);
            color: white;
            font-size: 1.2rem;
            padding: 0.7rem 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            width: auto;
        }

        .btn-back:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* Button Styles */
        .btn {
            font-family: 'Roboto', sans-serif;
            padding: 0.85rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            background-color: var(--primary-blue);
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(67, 97, 238, 0.2);
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(67, 97, 238, 0.3);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-large {
            width: 100%;
            padding: 1.2rem;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            border-radius: 10px;
        }

        .btn-link {
            background-color: var(--success-green);
        }

        .btn-link:hover {
            background-color: #05c290;
        }

        .btn-reminder {
            background-color: var(--warning-yellow);
            color: #333;
        }

        .btn-reminder:hover {
            background-color: #ffc952;
        }

        .btn-tracker-save {
            background-color: var(--accent-teal);
        }

        .btn-tracker-save:hover {
            background-color: #3ab9e0;
        }

        .btn-delete {
            background-color: var(--danger-red);
        }

        .btn-delete:hover {
            background-color: #ed2e5d;
        }

        .btn-saved-plans {
            background-color: var(--secondary-purple);
        }

        .btn-saved-plans:hover {
            background-color: #651a9e;
        }

        /* Main Content Area */
        main {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Year & Specialization Selection */
        #year-view main,
        #spec-view main {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        /* Motivational Quote */
        #motivational-quote {
            font-style: italic;
            color: var(--medium-text);
            text-align: center;
            margin: 1rem 0;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.05), rgba(114, 9, 183, 0.05));
            border-radius: var(--radius);
            border-left: 4px solid var(--primary-blue);
        }

        /* Improved Study Timer */
        .study-timer-container {
            width: 100%;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            margin: 1rem 0;
            box-shadow: var(--shadow);
        }

        .timer-inputs-container {
            display: flex;
            gap: 1.5rem;
            width: 100%;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        #pomodoro-subject-select {
            font-family: 'Roboto', sans-serif;
            font-size: 1.1rem;
            padding: 0.85rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white;
            min-width: 250px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }

        #pomodoro-subject-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .timer-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .timer-input-group label {
            font-size: 1rem;
            font-weight: 500;
            color: var(--medium-text);
            white-space: nowrap;
        }

        #pomodoro-time-input {
            font-family: 'Roboto', sans-serif;
            font-size: 1.1rem;
            padding: 0.85rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 120px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }

        #pomodoro-time-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        #pomodoro-timer-display {
            font-size: 4rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin: 0.5rem 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-family: 'Courier New', monospace;
        }

        .pomodoro-controls {
            display: flex;
            gap: 0.75rem;
        }

        /* Global Progress */
        .global-summary-container {
            width: 100%;
            margin: 1.5rem 0;
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        #global-summary-text {
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 1rem;
            color: var(--dark-text);
        }

        .global-progress-container {
            width: 100%;
            height: 30px;
            background-color: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        #global-progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--success-green), #06c290);
            border-radius: 15px;
            text-align: center;
            line-height: 30px;
            color: white;
            font-weight: 600;
            transition: width 0.8s cubic-bezier(0.22, 0.61, 0.36, 1);
            position: relative;
            overflow: hidden;
        }

        #global-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(-45deg,
                    rgba(255, 255, 255, 0.2) 25%,
                    transparent 25%,
                    transparent 50%,
                    rgba(255, 255, 255, 0.2) 50%,
                    rgba(255, 255, 255, 0.2) 75%,
                    transparent 75%,
                    transparent);
            background-size: 30px 30px;
            animation: move 2s linear infinite;
            border-radius: 15px;
        }

        @keyframes move {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 30px 30px;
            }
        }

        /* Schedule Grid */
        #schedule-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .schedule-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .schedule-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--secondary-purple));
        }

        .schedule-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        /* FADED (manual) "Done" state */
        .schedule-item.completed {
            opacity: 0.7;
            background: #f9f9f9;
        }

        .schedule-item.completed h3 {
            text-decoration: line-through;
        }

        /* GREEN (automatic) "Exam Passed" state */
        .schedule-item.past-due {
            background: #f0fff4;
            border-left: 5px solid var(--success-green);
            opacity: 1;
        }

        .schedule-item.past-due .countdown-timer {
            color: var(--success-green) !important;
            font-weight: 700;
        }

        .schedule-item.past-due h3 {
            text-decoration: none;
        }

        .schedule-item.past-due .completion-tracker input,
        .schedule-item.past-due .btn-reminder,
        .schedule-item.past-due .tracker-section input,
        .schedule-item.past-due .tracker-section button {
            pointer-events: none;
            background-color: #eee !important;
            color: #999 !important;
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
            transform: none;
        }

        .schedule-item.past-due .btn-link {
            opacity: 0.7;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .schedule-item h3 {
            color: var(--primary-blue);
            font-size: 1.5rem;
            margin: 0;
            font-weight: 600;
            flex: 1;
        }

        .completion-tracker {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--medium-text);
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .completion-tracker input[type="checkbox"] {
            width: 1.3rem;
            height: 1.3rem;
            cursor: pointer;
            accent-color: var(--success-green);
        }

        .exam-datetime {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            border-left: 3px solid var(--accent-teal);
        }

        .countdown-timer {
            font-size: 1.1rem;
            color: var(--primary-blue);
            margin-bottom: 1rem;
            font-weight: 600;
            min-height: 1.2rem;
            text-align: center;
            padding: 0.5rem;
            background: rgba(67, 97, 238, 0.05);
            border-radius: 6px;
        }

        .item-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        /* Tracker Inputs */
        .tracker-section {
            margin-top: 1rem;
            border-top: 1px dashed #ddd;
            padding-top: 1.5rem;
            margin-top: auto; /* Push tracker to bottom */
        }

        .tracker-section h4 {
            margin-bottom: 1rem;
            color: var(--medium-text);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tracker-inputs {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .tracker-inputs label {
            font-weight: 600;
            font-size: 1rem;
            min-width: 120px; /* Reduced width */
        }

        .tracker-inputs input[type="number"] {
            width: 80px; /* Reduced width */
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
            text-align: center;
            transition: var(--transition);
        }

        .tracker-inputs input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        /* Dynamic Chapter Pages List */
        .chapter-pages-list {
            display: grid;
            /* Adjust columns based on available space */
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.75rem;
            width: 100%;
            margin-top: 0.75rem;
            padding-left: 0; /* Removed padding */
        }

        .chapter-page-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            /* Allow wrapping if needed, but justify start */
            justify-content: flex-start;
            flex-wrap: wrap; /* Allow wrapping */
        }

        .chapter-page-input-group label {
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap; /* Prevent wrapping label text */
            flex-shrink: 0; /* Don't shrink label */
            margin-right: 5px;
            /* Give label a minimum width if needed */
            min-width: 100px;
            transition: all 0.2s ease-in-out; /* Add transition */
        }

        .chapter-page-input-group input[type="number"] {
            width: 70px;
            flex-shrink: 0;
            margin-right: 5px; /* Add space before checkbox */
            transition: all 0.2s ease-in-out; /* Add transition */
        }

        .chapter-page-input-group input[type="checkbox"] {
            width: 1.1rem;
            height: 1.1rem;
            cursor: pointer;
            accent-color: var(--success-green);
            flex-shrink: 0;
        }

        /* --- START: Strikethrough style for completed chapters --- */
        .chapter-page-input-group:has(input[type="checkbox"]:checked) label {
            text-decoration: line-through;
            color: var(--medium-text);
            opacity: 0.7;
        }

        .chapter-page-input-group:has(input[type="checkbox"]:checked) input[type="number"] {
            opacity: 0.7;
            background-color: #f0f0f0;
            text-decoration: line-through; /* Also strike through number */
        }
        /* --- END: Strikethrough style --- */

        /* --- MODAL STYLES --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            padding: 2.5rem;
            border-radius: var(--radius);
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            animation: modalSlideIn 0.4s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--medium-text);
            cursor: pointer;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--danger-red);
        }

        .modal-content h2 {
            color: var(--primary-blue);
            margin-bottom: 0;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1rem;
            font-size: 1.8rem;
        }

        /* --- Study Plan Modal --- */
        .plan-input-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: var(--radius);
        }

        .plan-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .plan-input-section label {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-text);
        }

        .plan-input-section input[type="number"] {
            padding: 0.85rem;
            font-size: 1.1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 100%;
            transition: var(--transition);
        }

        .plan-input-section input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        #run-plan-generator-btn {
            background-color: var(--success-green);
        }

        #plan-output-container {
            border-top: 1px solid var(--border-color);
            padding-top: 1.5rem;
        }

        /* Plan Output Styling */
        #plan-output h3 {
            color: var(--primary-blue);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        #plan-output .plan-day-group h3 {
            color: var(--secondary-purple);
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            background: linear-gradient(135deg, rgba(114, 9, 183, 0.1), transparent);
            padding: 0.75rem;
            border-radius: 8px;
        }

        #plan-output p {
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        #plan-output .plan-note {
            font-size: 0.9rem;
            color: var(--medium-text);
            margin-top: -0.5rem;
            font-style: italic;
        }

        #plan-output .warning {
            color: #856404;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }

        #plan-output .success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        #plan-output ul {
            list-style: none;
            padding-left: 0;
        }

        #plan-output li {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 5px solid var(--accent-teal);
            transition: var(--transition);
        }

        #plan-output li:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        #plan-output li strong {
            color: var(--dark-text);
            margin-right: 0.5rem;
        }

        #plan-output li span {
            font-size: 0.9rem;
            color: var(--medium-text);
            margin-top: 0.25rem;
            display: block;
        }

        /* --- Stats Modal --- */
        #stats-list-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        #stats-summary {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: var(--radius);
        }

        #stats-summary h3 {
            color: var(--primary-blue);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }

        #stats-summary p {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        #stats-summary p strong {
            color: var(--dark-text);
        }

        #stats-log {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 0.5rem;
            background: white;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .stat-item:hover {
            background: #f8f9fa;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-item-info {
            font-size: 1rem;
            flex: 1;
        }

        .stat-item-info strong {
            color: var(--primary-blue);
        }

        .stat-item-info span {
            font-size: 0.9rem;
            color: var(--medium-text);
            display: block;
            margin-top: 0.25rem;
        }

        .delete-stat-btn {
            background: var(--danger-red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .delete-stat-btn:hover {
            background: #ed2e5d;
            transform: scale(1.1);
        }

        /* --- Toast Notification Styles --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
            min-width: 300px;
        }

        .toast.toast--reminder {
            animation: slideIn 0.3s ease, fadeOut 0.5s ease 4.5s forwards;
            background-color: var(--warning-yellow);
            color: #333;
        }

        .toast-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .toast--success {
            background-color: var(--success-green);
        }

        .toast--error {
            background-color: var(--danger-red);
        }

        .toast--info {
            background-color: var(--accent-teal);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* --- Saved Plans Styles --- */
        .saved-plans-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .saved-plan-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
        }

        .saved-plan-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .saved-plan-item.completed {
            background: #f0fff4;
            border-left: 5px solid var(--success-green);
        }

        .saved-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .saved-plan-title {
            font-size: 1.4rem;
            color: var(--primary-blue);
            font-weight: 600;
            margin: 0;
        }

        .saved-plan-date {
            font-size: 0.9rem;
            color: var(--medium-text);
        }

        .saved-plan-actions {
            display: flex;
            gap: 0.5rem;
        }

        .saved-plan-content {
            margin-bottom: 1rem;
        }

        .saved-plan-days {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .saved-plan-day {
            position: relative;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--accent-teal);
            transition: var(--transition);
        }

        .saved-plan-day.completed {
            background: #e8f5e8;
            border-left: 4px solid var(--success-green);
        }

        .saved-plan-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .saved-plan-day-title {
            font-weight: 600;
            color: var(--dark-text);
            margin: 0;
            flex: 1;
        }

        .day-completion-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .day-completion-toggle input[type="checkbox"] {
            width: 1.2rem;
            height: 1.2rem;
            cursor: pointer;
            accent-color: var(--success-green);
        }

        .saved-plan-day-tasks {
            padding-left: 1rem;
        }

        .saved-plan-day-task {
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .saved-plan-day-task input[type="checkbox"] {
            width: 1.1rem;
            height: 1.1rem;
            cursor: pointer;
            accent-color: var(--success-green);
        }

        .saved-plan-day-task.completed {
            text-decoration: line-through;
            color: var(--medium-text);
        }

        .no-plans-message {
            text-align: center;
            padding: 2rem;
            color: var(--medium-text);
            font-style: italic;
        }

        .plan-completion-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--border-color);
        }

        .plan-save-section {
            display: none;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .complete-all-days-btn {
            background-color: var(--success-green);
            margin-top: 0.5rem;
        }

        .complete-all-days-btn:hover {
            background-color: #05c290;
        }

        /* زر العودة للأعلى */
        #back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--primary-blue);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: var(--transition);
            z-index: 100;
            border: none;
        }

        #back-to-top:hover {
            background: var(--primary-dark);
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 1rem 0.5rem;
            }

            .app-container {
                border-radius: 10px;
            }

            .view {
                padding: 1.5rem;
            }

            header h1 {
                font-size: 2rem;
            }

            .header-with-action {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-title-container {
                width: 100%;
                justify-content: space-between;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .header-actions .btn {
                flex: 1;
                text-align: center;
            }

            #schedule-list {
                grid-template-columns: 1fr;
            }

            .timer-inputs-container {
                flex-direction: column;
                align-items: stretch;
            }

            .timer-input-group {
                width: 100%;
                justify-content: space-between;
            }

            #pomodoro-subject-select {
                min-width: auto;
                width: 100%;
            }

            .modal-content {
                padding: 1.5rem;
                width: 95%;
            }

            .chapter-pages-list {
                /* On medium screens, maybe 2 columns */
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }

            .toast {
                min-width: 250px;
            }

            .saved-plan-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .saved-plan-actions {
                width: 100%;
                justify-content: flex-end;
            }

            #back-to-top {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
            }
        }

        @media (max-width: 480px) {
            .view {
                padding: 1rem;
            }

            header h1 {
                font-size: 1.7rem;
            }

            .btn-large {
                padding: 1rem;
                font-size: 1.1rem;
            }

            #pomodoro-timer-display {
                font-size: 3rem;
            }

            .item-actions {
                flex-direction: column;
            }

            .item-actions .btn {
                width: 100%;
            }

            .input-group {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }

            .tracker-inputs label {
                min-width: auto;
            }

            .timer-input-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .chapter-pages-list {
                /* Stack chapters on very small screens */
                grid-template-columns: 1fr;
            }

            .chapter-page-input-group {
                justify-content: space-between;
                /* Ensure spacing on small screens */
            }

            #back-to-top {
                bottom: 15px;
                right: 15px;
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
        }
        plan-save-section {
    display: flex;
    align-items: flex-end; /* محاذاة العناصر للأسفل */
    gap: 16px; /* مسافة بين مربع الإدخال والزر */
    background-color: #ffffff; /* خلفية بيضاء ناصعة */
    padding: 24px; /* زيادة بسيطة في الحشو */
    border-radius: 12px;
    border: 1px solid #e0e0e0; /* حدود رمادية فاتحة جداً */
    /* ظل ناعم جداً لإعطاء إحساس بالرفع */
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05); 
    max-width: 700px;
    margin: 20px auto;
    flex-wrap: wrap; /* للسماح بالالتفاف في الشاشات الصغيرة */
}

.plan-input-group {
    flex-grow: 1; /* لجعل حقل الإدخال يأخذ المساحة المتاحة */
    display: flex;
    flex-direction: column;
    min-width: 200px;
}

.plan-input-group label {
    font-size: 0.85rem;
    color: #555; /* لون رمادي داكن للعنوان */
    margin-bottom: 8px;
    font-weight: 500;
}

.plan-input-group input[type="text"] {
    width: 100%;
    padding: 14px 16px;
    font-size: 1rem;
    color: #111; /* لون نص داكن */
    background-color: #ffffff; /* خلفية بيضاء */
    border: 1px solid #ccc; /* حدود رمادية واضحة */
    border-radius: 8px;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    box-sizing: border-box; 
}

.plan-input-group input[type="text"]::placeholder {
    color: #999; /* لون رمادي متوسط للنص المؤقت */
}

.plan-input-group input[type="text"]:focus {
    outline: none;
    border-color: #007bff; /* نفس اللون الأزرق المميز */
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15); /* توهج أزرق خفيف */
}

/* تصميم الزر (بنفس التدرج اللوني) */
.btn#save-plan-btn {
    padding: 14px 24px;
    font-size: 1rem;
    font-weight: 600;
    color: #ffffff;
    background: linear-gradient(90deg, #007bff, #0056b3);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s ease;
    /* ظل أزرق متناسب مع الزر */
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2); 
    flex-shrink: 0;
}

.btn#save-plan-btn:hover {
    background: linear-gradient(90deg, #0069d9, #004a99);
    box-shadow: 0 6px 16px rgba(0, 123, 255, 0.3);
    transform: translateY(-2px);
}

.btn#save-plan-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
}

/* --- جزء التجاوب مع الأجهزة (Responsive) --- */
/* (هذا الجزء لم يتغير، فهو يعتمد على التخطيط وليس الألوان) */

@media (max-width: 600px) {
    .plan-save-section {
        flex-direction: column;
        align-items: stretch;
    }

    .plan-input-group {
        width: 100%;
        margin-right: 0;
        min-width: unset;
    }

    .btn#save-plan-btn {
        width: 100%;
        padding: 16px;
    }
}
    </style>
</head>

<body>

    <div id="toast-container"></div>

    <!-- زر العودة للأعلى -->
    <button id="back-to-top" title="Back to Top">
        <i class="fas fa-arrow-up"></i>
    </button>

    <div class="app-container">

        <div id="year-view" class="view active">
            <header>
                <h1><i class="fas fa-graduation-cap"></i>MaterialX | Smart Student Organizer</h1>
                <p>Please select your academic year:</p>
            </header>
            <main>
                <button class="btn btn-large" data-year="1"><i class="fas fa-calendar-alt"></i> Year 1</button>
                <button class="btn btn-large" data-year="2"><i class="fas fa-calendar-alt"></i> Year 2</button>
                <button class="btn btn-large" data-year="3"><i class="fas fa-calendar-alt"></i> Year 3</button>
                <button class="btn btn-large" data-year="4"><i class="fas fa-calendar-alt"></i> Year 4</button>
            </main>
        </div>

        <div id="spec-view" class="view">
            <header>
                <button id="back-to-year" class="btn btn-back"><i class="fas fa-arrow-left"></i></button>
                <h1>Select Specialization</h1>
                <p>Please select your specialization:</p>
            </header>
            <main>
                <button class="btn btn-large" data-spec="IS"><i class="fas fa-database"></i> Information
                    Systems (IS)</button>
                <button class="btn btn-large" data-spec="CS"><i class="fas fa-laptop-code"></i> Computer
                    Science (CS)</button>
                <button class="btn btn-large" data-spec="AI"><i class="fas fa-robot"></i> Artificial
                    Intelligence (AI)</button>
            </main>
        </div>

        <div id="schedule-view" class="view">
            <header class="header-with-action">
                <div class="header-title-container">
                    <button id="back-to-selection" class="btn btn-back"><i class="fas fa-arrow-left"></i></button>
                    <h1 id="schedule-title">Your Schedule</h1>
                </div>
                <div class="header-actions">
                    <button class="btn" id="show-stats-btn"><i class="fas fa-chart-bar"></i> View Stats</button>
                    <button class="btn btn-saved-plans" id="show-saved-plans-btn"><i class="fas fa-bookmark"></i> Saved Plans</button>
                    <button class="btn" id="generate-plan-btn"><i class="fas fa-calendar-check"></i> Generate Study Plan</button>
                </div>
            </header>

            <p id="motivational-quote">"The best way to predict the future is to create it." - Peter Drucker</p>

            <div class="study-timer-container">
                <div class="timer-inputs-container">
                    <select id="pomodoro-subject-select">
                        <option value="">Select a subject to study</option>
                    </select>
                    <div class="timer-input-group">
                        <label for="pomodoro-time-input">Enter time (1-600 minutes):</label>
                        <input type="number" id="pomodoro-time-input" value="25" min="1" max="600" />
                    </div>
                </div>

                <span id="pomodoro-timer-display">25:00</span>

                <div class="pomodoro-controls">
                    <button class="btn" id="pomodoro-start"><i class="fas fa-play"></i> Start</button>
                    <button class="btn" id="pomodoro-pause" style="display:none;"><i class="fas fa-pause"></i> Pause</button>
                    <button class="btn" id="pomodoro-reset"><i class="fas fa-redo"></i> Reset</button>
                </div>
            </div>

            <div class="global-summary-container">
                <p id="global-summary-text">Loading summary...</p>
                 <div class="global-progress-container" title="Your overall progress (based on subjects marked done)">
                    <div id="global-progress-bar">0%</div>
                </div>
            </div>

            <main id="schedule-list">
                </main>
        </div>

    </div>

    <!-- نافذة الخطط المحفوظة -->
    <div id="saved-plans-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-saved-plans-modal-btn" class="modal-close">&times;</button>
            <h2><i class="fas fa-bookmark"></i> Saved Study Plans</h2>

            <div class="saved-plans-container" id="saved-plans-list">
                <!-- سيتم ملؤها ديناميكياً -->
            </div>

            <div class="plan-actions" style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-delete" id="delete-all-plans-btn"><i class="fas fa-trash-alt"></i> Delete All Plans</button>
            </div>
        </div>
    </div>

    <!-- نافذة إنشاء الخطة (مع إضافة زر الحفظ) -->
    <div id="plan-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-modal-btn" class="modal-close">&times;</button>
            <h2><i class="fas fa-tasks"></i> Create Your Daily Study Plan</h2>

            <div class="plan-input-section">
                <div class="plan-input-group">
                    <label for="hours-per-day">How many hours can you realistically study per day? (2-12)</label>
                    <input type="number" id="hours-per-day" min="2" max="12" placeholder="e.g., 6">
                </div>
                <button class="btn" id="run-plan-generator-btn"><i class="fas fa-calculator"></i> Generate Daily Plan</button>
            </div>

            <div id="plan-output-container">
                <div id="plan-output">
                    <p>Enter your daily hours (between 2 and 12) to generate a plan.</p>
                </div>
                
                <!-- زر حفظ الخطة -->
                <div id="plan-save-section" class="plan-save-section">
                    <div class="plan-input-group">
                        <label for="plan-name">Plan Name (Optional)</label>
                        <input type="text" id="plan-name" placeholder="e.g., Final Exam Prep Plan">
                    </div>
                    <button class="btn" id="save-plan-btn"><i class="fas fa-save"></i> Save This Plan</button>
                </div>
            </div>
        </div>
    </div>

    <div id="stats-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-stats-modal-btn" class="modal-close">&times;</button>
            <h2><i class="fas fa-chart-line"></i> Study Statistics</h2>

            <div id="stats-list-container">
                <div id="stats-summary">
                    <h3>Summary by Subject</h3>
                </div>
                <h3>Session Log</h3>
                <div id="stats-log">
                </div>
                <button class="btn btn-delete" id="delete-all-stats-btn"><i class="fas fa-trash-alt"></i> Delete All Statistics</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const scheduleData = {
                '1': [
                    { id: 'y1_stat1', subjectName: 'Statistics 1', dateTime: '2025-11-02T09:00:00', materialUrl: 'material.html' },
                    { id: 'y1_phys1', subjectName: 'Physics 1', dateTime: '2025-11-03T09:00:00', materialUrl: 'material.html' },
                    { id: 'y1_eng1', subjectName: 'English 1', dateTime: '2025-11-03T11:00:00', materialUrl: 'material.html' },
                    { id: 'y1_math1', subjectName: 'Mathematics 1', dateTime: '2025-11-04T09:00:00', materialUrl: 'material.html' },
                    { id: 'y1_introcs', subjectName: 'Introduction to Computer (CS)', dateTime: '2025-11-05T09:00:00', materialUrl: 'material.html' },
                    { id: 'y1_is', subjectName: 'Information System (IS)', dateTime: '2025-11-06T09:00:00', materialUrl: 'material.html' }
                ],
                '2': [
                    { id: 'y2_dc', subjectName: 'DC', dateTime: '2025-11-02T10:00:00', materialUrl: 'material.html' },
                    { id: 'y2_pl2', subjectName: 'PL-2', dateTime: '2025-11-02T13:00:00', materialUrl: 'material.html' },
                    { id: 'y2_db1', subjectName: 'DB-1', dateTime: '2025-11-03T13:00:00', materialUrl: 'material.html' },
                    { id: 'y2_logic', subjectName: 'Digital Logic', dateTime: '2025-11-04T11:00:00', materialUrl: 'material.html' },
                    { id: 'y2_ds', subjectName: 'DS', dateTime: '2025-11-05T10:00:00', materialUrl: 'material.html' },
                    { id: 'y2_hr', subjectName: 'Human Rights', dateTime: '2025-11-06T10:00:00', materialUrl: 'material.html' },
                    { id: 'y2_sa1', subjectName: 'SA-1', dateTime: '2025-11-06T12:00:00', materialUrl: 'material.html' }
                ],
                '3_IS': [
                    { id: 'y3is_bi', subjectName: 'Data Analytics (BI)', dateTime: '2025-11-02T14:00:00', materialUrl: 'material.html' },
                    { id: 'y3is_db2', subjectName: 'Database 2', dateTime: '2025-11-03T13:00:00', materialUrl: 'material.html' },
                    { id: 'y3is_ai', subjectName: 'Artificial Intelligence', dateTime: '2025-11-04T13:00:00', materialUrl: 'material.html' },
                    { id: 'y3is_bigdata', subjectName: 'Big Data', dateTime: '2025-11-05T12:00:00', materialUrl: 'material.html' },
                    { id: 'y3is_storage', subjectName: 'Data Storage', dateTime: '2025-11-06T09:00:00', materialUrl: 'material.html' },
                    { id: 'y3is_dm', subjectName: 'Data Mining', dateTime: '2025-11-06T14:00:00', materialUrl: 'material.html' }
                ],
                '3_CS': [
                    { id: 'y3cs_ml', subjectName: 'Machine Learning', dateTime: '2025-11-02T14:00:00', materialUrl: 'material.html' },
                    { id: 'y3cs_db2', subjectName: 'Database 2', dateTime: '2025-11-03T13:00:00', materialUrl: 'material.html' },
                    { id: 'y3cs_org', subjectName: 'Computer Organization', dateTime: '2025-11-04T12:00:00', materialUrl: 'material.html' },
                    { id: 'y3cs_ai', subjectName: 'Artificial Intelligence', dateTime: '2025-11-04T13:00:00', materialUrl: 'material.html' },
                    { id: 'y3cs_concepts', subjectName: 'Concepts in Computer Science', dateTime: '2025-11-05T12:00:00', materialUrl: 'material.html' },
                    { id: 'y3cs_os2', subjectName: 'Operating System - 2', dateTime: '2025-11-05T13:00:00', materialUrl: 'material.html' },
                    { id: 'y3cs_parallel', subjectName: 'Parallel Processing', dateTime: '2025-11-05T14:00:00', materialUrl: 'material.html' }
                ],
                '3_AI': [
                    { id: 'y3ai_ml', subjectName: 'Machine Learning', dateTime: '2025-11-02T14:00:00', materialUrl: 'material.html' },
                    { id: 'y3ai_db2', subjectName: 'Database 2', dateTime: '2025-11-03T13:00:00', materialUrl: 'material.html' },
                    { id: 'y3ai_convex', subjectName: 'Convex Optimization', dateTime: '2025-11-04T10:00:00', materialUrl: 'material.html' },
                    { id: 'y3ai_ai', subjectName: 'Artificial Intelligence', dateTime: '2025-11-04T13:00:00', materialUrl: 'material.html' },
                    { id: 'y3ai_bigdata', subjectName: 'Big Data', dateTime: '2025-11-05T12:00:00', materialUrl: 'material.html' },
                    { id: 'y3ai_parallel', subjectName: 'Parallel Processing', dateTime: '2025-11-05T14:00:00', materialUrl: 'material.html' }
                ],
                '4_IS': [
                    { id: 'y4is_pl3', subjectName: 'PL-3', dateTime: '2025-11-02T12:00:00', materialUrl: 'material.html' },
                    { id: 'y4is_iss', subjectName: 'ISS', dateTime: '2025-11-03T12:00:00', materialUrl: 'material.html' },
                    { id: 'y4is_ethics', subjectName: 'Ethics', dateTime: '2025-11-04T14:00:00', materialUrl: 'material.html' },
                    { id: 'y4is_ds', subjectName: 'Data Science', dateTime: '2025-11-05T13:00:00', materialUrl: 'material.html' },
                    { id: 'y4is_qa', subjectName: 'Quality Testing', dateTime: '2025-11-06T13:00:00', materialUrl: 'material.html' }
                ],
                '4_CS': [
                    { id: 'y4cs_pl3', subjectName: 'PL-3', dateTime: '2025-11-02T12:00:00', materialUrl: 'material.html' },
                    { id: 'y4cs_mm', subjectName: 'Multimedia', dateTime: '2025-11-03T14:00:00', materialUrl: 'material.html' },
                    { id: 'y4cs_ip', subjectName: 'Image Processing', dateTime: '2025-11-04T11:00:00', materialUrl: 'material.html' },
                    { id: 'y4cs_ethics', subjectName: 'Ethics', dateTime: '2025-11-04T14:00:00', materialUrl: 'material.html' },
                    { id: 'y4cs_deep', subjectName: 'Deep and Neural', dateTime: '2025-11-06T14:00:00', materialUrl: 'material.html' }
                ],
                '4_AI': [
                    { id: 'y4ai_pl3', subjectName: 'PL-3', dateTime: '2025-11-02T12:00:00', materialUrl: 'material.html' },
                    { id: 'y4ai_deep', subjectName: 'Digital Signal', dateTime: '2025-11-03T09:00:00', materialUrl: 'material.html' },
                    { id: 'y4ai_ip', subjectName: 'Image Processing', dateTime: '2025-11-04T11:00:00', materialUrl: 'material.html' },
                    { id: 'y4ai_ethics', subjectName: 'Ethics', dateTime: '2025-11-04T14:00:00', materialUrl: 'material.html' },
                    { id: 'y4ai_ds', subjectName: 'Data Science', dateTime: '2025-11-05T13:00:00', materialUrl: 'material.html' },
                    { id: 'y4ai_deep', subjectName: 'Deep and Neural', dateTime: '2025-11-06T14:00:00', materialUrl: 'material.html' }
                ]
            };

            const motivationalQuotes = [
                "The best way to predict the future is to create it.",
                "Success is not final, failure is not fatal: it is the courage to continue that counts.",
                "The secret of getting ahead is getting started."
            ];

            // --- View Elements ---
            const yearView = document.getElementById('year-view');
            const specView = document.getElementById('spec-view');
            const scheduleView = document.getElementById('schedule-view');
            const scheduleTitle = document.getElementById('schedule-title');
            const scheduleList = document.getElementById('schedule-list');
            const quoteElement = document.getElementById('motivational-quote');
            const globalProgressBar = document.getElementById('global-progress-bar');
            const globalSummaryText = document.getElementById('global-summary-text');
            const savedPlansModal = document.getElementById('saved-plans-modal');
            const showSavedPlansBtn = document.getElementById('show-saved-plans-btn');
            const closeSavedPlansModalBtn = document.getElementById('close-saved-plans-modal-btn');
            const savedPlansList = document.getElementById('saved-plans-list');
            const deleteAllPlansBtn = document.getElementById('delete-all-plans-btn');
            const planSaveSection = document.getElementById('plan-save-section');
            const savePlanBtn = document.getElementById('save-plan-btn');
            const planNameInput = document.getElementById('plan-name');

            // --- Back Buttons ---
            const backToYearBtn = document.getElementById('back-to-year');
            const backToSelectionBtn = document.getElementById('back-to-selection');

            // --- Plan Modal Elements ---
            const planModal = document.getElementById('plan-modal');
            const closePlanModalBtn = document.getElementById('close-modal-btn');
            const generatePlanBtn = document.getElementById('generate-plan-btn');
            const runPlanGeneratorBtn = document.getElementById('run-plan-generator-btn');
            const hoursPerDayInput = document.getElementById('hours-per-day');
            const planOutput = document.getElementById('plan-output');

            // --- Stats Modal Elements ---
            const statsModal = document.getElementById('stats-modal');
            const showStatsBtn = document.getElementById('show-stats-btn');
            const closeStatsModalBtn = document.getElementById('close-stats-modal-btn');
            const statsListContainer = document.getElementById('stats-list-container');
            const statsSummaryEl = document.getElementById('stats-summary');
            const statsLogEl = document.getElementById('stats-log');
            const deleteAllStatsBtn = document.getElementById('delete-all-stats-btn');

            // --- Timer Elements ---
            const pomodoroTimeInput = document.getElementById('pomodoro-time-input');
            const pomodoroTimerDisplay = document.getElementById('pomodoro-timer-display');
            const pomodoroSubjectSelect = document.getElementById('pomodoro-subject-select');
            const pomodoroStartBtn = document.getElementById('pomodoro-start');
            const pomodoroPauseBtn = document.getElementById('pomodoro-pause');
            const pomodoroResetBtn = document.getElementById('pomodoro-reset');

            // --- State Management ---
            let viewState = { year: null, spec: null, previousView: null, currentScheduleKey: null };
            let countdownInterval = null;
            let pomodoroInterval = null;
            let pomodoroTimeLeft = 25 * 60; // Default: 25 minutes in seconds
            let pomodoroInitialTime = 25 * 60;
            let isPomodoroRunning = false;
            const DEFAULT_PAGES_PER_HOUR = 15; // Assumption for suggesting hours

            // --- Toast Notification Function ---
            function showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toast-container');

                const toast = document.createElement('div');
                toast.className = `toast toast--${type}`;

                let icon = 'ℹ️';
                if (type === 'success') icon = '✔️';
                if (type === 'error') icon = '✖️';
                if (type === 'reminder') {
                    icon = '🔔';
                    toast.classList.add('toast--reminder');
                }

                toast.innerHTML = `
                    <span class="toast-icon">${icon}</span>
                    <span class="toast-message">${message}</span>
                `;

                toastContainer.appendChild(toast);

                const duration = (type === 'reminder') ? 5000 : 3000;
                setTimeout(() => {
                    toast.remove();
                }, duration);
            }

            // --- View Navigation ---
            function navigateTo(viewId) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                if (viewId === 'schedule-view') {
                    startLiveCountdowns();
                } else {
                    stopLiveCountdowns();
                }
            }

            // --- Event Listeners (Year, Spec, Back) ---
            yearView.addEventListener('click', (e) => {
                if (e.target.matches('.btn[data-year]')) {
                    viewState.year = e.target.dataset.year;
                    viewState.previousView = 'year-view';
                    const needsSpec = viewState.year === '3' || viewState.year === '4';
                    if (needsSpec) {
                        navigateTo('spec-view');
                    } else {
                        viewState.spec = null;
                        viewState.currentScheduleKey = viewState.year;
                        displaySchedule(viewState.currentScheduleKey);
                        navigateTo('schedule-view');
                    }
                }
            });
            specView.addEventListener('click', (e) => {
                if (e.target.matches('.btn[data-spec]')) {
                    viewState.spec = e.target.dataset.spec;
                    viewState.previousView = 'spec-view';
                    viewState.currentScheduleKey = `${viewState.year}_${viewState.spec}`;
                    displaySchedule(viewState.currentScheduleKey);
                    navigateTo('schedule-view');
                }
            });
            backToYearBtn.addEventListener('click', () => navigateTo('year-view'));
            backToSelectionBtn.addEventListener('click', () => navigateTo(viewState.previousView));

            // --- Event Listeners for Modals ---
            generatePlanBtn.addEventListener('click', () => {
                planModal.style.display = 'flex';
                planOutput.innerHTML = '<p>Enter your daily hours (between 2 and 12) to generate a plan.</p>';
                hoursPerDayInput.value = '';
                planSaveSection.style.display = 'none';
            });
            closePlanModalBtn.addEventListener('click', () => planModal.style.display = 'none');
            planModal.addEventListener('click', (e) => {
                if (e.target === planModal) planModal.style.display = 'none';
            });
            runPlanGeneratorBtn.addEventListener('click', generateDailyStudyPlan);

            showStatsBtn.addEventListener('click', () => {
                displayStudyStats();
                statsModal.style.display = 'flex';
            });
            closeStatsModalBtn.addEventListener('click', () => statsModal.style.display = 'none');
            statsModal.addEventListener('click', (e) => {
                if (e.target === statsModal) statsModal.style.display = 'none';
            });

            // --- Function to Display Schedule ---
            function displaySchedule(key) {
                quoteElement.textContent = `"${motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)]}"`;
                const data = scheduleData[key];
                let title = `Year ${viewState.year}`;
                if (viewState.spec) title += ` - ${viewState.spec}`;
                scheduleTitle.textContent = title;
                scheduleList.innerHTML = '';
                pomodoroSubjectSelect.innerHTML = '<option value="">Select a subject to study</option>';

                if (!data || data.length === 0) {
                    scheduleList.innerHTML = '<p>No schedule found for this selection.</p>';
                    updateGlobalProgress();
                    return;
                }

                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.subjectName;
                    option.textContent = item.subjectName;
                    pomodoroSubjectSelect.appendChild(option);

                    const trackerData = loadTrackerData(item.id);

                    const eventDate = new Date(item.dateTime);
                    const formattedDateTime = eventDate.toLocaleString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });

                    const itemCard = document.createElement('div');
                    itemCard.className = 'schedule-item';
                    itemCard.id = `item-card-${item.id}`;
                    itemCard.innerHTML = `
                        <div class="item-header">
                            <h3>${item.subjectName}</h3>
                            <div class="completion-tracker">
                                <input type="checkbox" id="done-${item.id}" data-item-id="${item.id}" ${trackerData.isComplete ? 'checked' : ''} title="Mark entire subject as done">
                                <label for="done-${item.id}">Done</label>
                            </div>
                        </div>

                        <p class="exam-datetime">Exam Date: ${formattedDateTime}</p>

                        <p class="countdown-timer" data-datetime="${item.dateTime}">Loading countdown...</p>

                        <div class="item-actions">
                            <button class="btn btn-reminder" data-id="${item.id}">Set Reminder</button>
                            <a href="${item.materialUrl}" target="_blank" class="btn btn-link">Material Link</a>
                        </div>
                        <div class="tracker-section" data-item-id="${item.id}">
                            <h4><i class="fas fa-book-reader"></i> Study Tracker</h4>
                            <div class="tracker-inputs">
                                <div class="input-group">
                                    <label for="total-chapters-${item.id}">Total Chapters:</label>
                                    <input type="number" id="total-chapters-${item.id}" class="tracker-total-chapters" min="0" value="${trackerData.totalChapters}">
                                </div>
                                <div class="chapter-pages-list" id="chapter-pages-container-${item.id}">
                                    </div>
                                <button class="btn btn-tracker-save"><i class="fas fa-save"></i> Save Progress</button>
                            </div>
                        </div>
                    `;
                    scheduleList.appendChild(itemCard);

                    updateCardCompletionState(item.id, trackerData.isComplete);
                    const countdownEl = itemCard.querySelector('.countdown-timer');
                    const eventTime = new Date(item.dateTime).getTime();
                    const now = new Date().getTime();
                    const distance = eventTime - now;
                    checkAndDisableIfPastDue(countdownEl, distance);

                    generateChapterInputs(item.id, trackerData.totalChapters, trackerData.chapterPages, trackerData.chapterCompletion);
                });
                updateGlobalProgress();
                startLiveCountdowns();
                updateTimerFromInput();
            }

            // --- Event Delegation for Dynamic Content ---
            scheduleList.addEventListener('click', (e) => {
                const reminderBtn = e.target.closest('.btn-reminder');
                if (reminderBtn) {
                    const item = findItemById(reminderBtn.dataset.id);
                    if (item) setReminder(item);
                }
                const saveBtn = e.target.closest('.btn-tracker-save');
                if (saveBtn) {
                    const trackerSection = e.target.closest('.tracker-section');
                    const itemId = trackerSection.dataset.itemId;
                    saveTrackerData(itemId);
                    showToast("Progress saved!", 'success');
                    updateGlobalProgress();
                }
            });
            scheduleList.addEventListener('input', (e) => {
                const totalChaptersInput = e.target.closest('.tracker-total-chapters');
                if (totalChaptersInput) {
                    const itemId = totalChaptersInput.closest('.tracker-section').dataset.itemId;
                    const chapterCount = parseInt(totalChaptersInput.value, 10) || 0;
                    const existingData = loadTrackerData(itemId);
                    const currentCompletion = existingData.chapterCompletion || [];
                    generateChapterInputs(itemId, chapterCount, existingData.chapterPages, currentCompletion);
                    saveTrackerData(itemId);
                    updateGlobalProgress();
                }
            });
             scheduleList.addEventListener('change', (e) => {
                const completionCheckbox = e.target.closest('.completion-tracker input[type="checkbox"]');
                const chapterCheckbox = e.target.closest('.chapter-completion-checkbox');

                if (completionCheckbox) {
                    const itemId = completionCheckbox.dataset.itemId;
                    const isComplete = completionCheckbox.checked;
                    updateCardCompletionState(itemId, isComplete);
                    if (isComplete) {
                        const chapterCheckboxes = document.querySelectorAll(`#chapter-pages-container-${itemId} .chapter-completion-checkbox`);
                        chapterCheckboxes.forEach(cb => cb.checked = true);
                    } else {
                         const chapterCheckboxes = document.querySelectorAll(`#chapter-pages-container-${itemId} .chapter-completion-checkbox`);
                         chapterCheckboxes.forEach(cb => cb.checked = false);
                    }
                    saveTrackerData(itemId);
                    updateGlobalProgress();
                } else if (chapterCheckbox) {
                    const itemId = chapterCheckbox.closest('.tracker-section').dataset.itemId;
                    saveTrackerData(itemId);

                    const allChapterCheckboxes = document.querySelectorAll(`#chapter-pages-container-${itemId} .chapter-completion-checkbox`);
                    const allChaptersDone = allChapterCheckboxes.length > 0 && Array.from(allChapterCheckboxes).every(cb => cb.checked);
                    const subjectCheckbox = document.getElementById(`done-${itemId}`);

                     if (subjectCheckbox && !subjectCheckbox.disabled) {
                         if (allChaptersDone) {
                             subjectCheckbox.checked = true;
                             updateCardCompletionState(itemId, true);
                             saveTrackerData(itemId);
                         } else if (!chapterCheckbox.checked && subjectCheckbox.checked) {
                             subjectCheckbox.checked = false;
                             updateCardCompletionState(itemId, false);
                             saveTrackerData(itemId);
                         }
                     }

                    updateGlobalProgress();
                }
            });

            function generateChapterInputs(itemId, chapterCount, savedPages = [], savedCompletion = []) {
                const container = document.getElementById(`chapter-pages-container-${itemId}`);
                if (!container) return;
                container.innerHTML = '';
                for (let i = 1; i <= chapterCount; i++) {
                    const pageCount = savedPages[i - 1] || '';
                    const isChapterComplete = savedCompletion[i - 1] === true;
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'chapter-page-input-group';
                    inputGroup.innerHTML = `
                        <label for="chapter-${itemId}-${i}">Chapter ${i} Pages:</label>
                        <input type="number" id="chapter-${itemId}-${i}" class="chapter-page-input" min="0" value="${pageCount}">
                        <input type="checkbox" id="chapter-done-${itemId}-${i}" class="chapter-completion-checkbox" data-chapter-index="${i - 1}" ${isChapterComplete ? 'checked' : ''} title="Mark Chapter ${i} as complete">
                    `;
                    container.appendChild(inputGroup);
                }
            }
            function updateCardCompletionState(itemId, isComplete) {
                const card = document.getElementById(`item-card-${itemId}`);
                if (card) {
                    card.classList.toggle('completed', isComplete);
                }
            }

            // --- Reminder function ---
            async function setReminder(item) {
                 const hoursBefore = prompt("How many hours before the exam to be notified? (Min: 1, Max: 24)", "2");

                if (hoursBefore === null) return;

                const hours = parseInt(hoursBefore, 10);

                if (isNaN(hours) || hours < 1 || hours > 24) {
                    showToast("Please enter a valid number of hours between 1 and 24.", 'error');
                    return;
                }

                const eventTime = new Date(item.dateTime);
                const now = new Date();
                const reminderTime = new Date(eventTime.getTime() - (hours * 60 * 60 * 1000));

                if (reminderTime < now) {
                    showToast(`Cannot set reminder: The time (${hours} hours before) has already passed.`, 'error');
                    return;
                }

                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    showToast('Desktop notification permission was denied. In-page alerts will still work.', 'info');
                }

                const timeUntilReminder = reminderTime.getTime() - now.getTime();

                setTimeout(() => {
                    const eventDate = new Date(item.dateTime);
                    const formattedTime = eventDate.toLocaleString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                    const formattedDate = eventDate.toLocaleString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

                    const message = `Reminder: Your exam for ${item.subjectName} is in ${hours} hours (at ${formattedTime} on ${formattedDate}).`;

                    if (permission === 'granted') {
                        new Notification('Exam Reminder!', {
                            body: message,
                            requireInteraction: true
                        });
                    }

                    showToast(message, 'reminder');

                }, timeUntilReminder);

                showToast(`Reminder set! You will be notified ${hours} hours before the ${item.subjectName} exam.`, 'success');
            }
            function findItemById(id) {
                 for (const key in scheduleData) {
                    const found = scheduleData[key].find(item => item.id === id);
                    if (found) return found;
                }
                return null;
            }

            // --- LocalStorage Functions ---
            function loadTrackerData(itemId) {
                const key = `tracker_${itemId}`;
                const data = localStorage.getItem(key);
                const defaults = { isComplete: false, totalChapters: 0, chapterPages: [], chapterCompletion: [] };
                if (data) {
                    const parsed = JSON.parse(data);
                    parsed.chapterCompletion = parsed.chapterCompletion || [];
                    const adjustedCompletion = new Array(parsed.totalChapters).fill(false);
                    for(let i=0; i<parsed.totalChapters; i++){
                         if(parsed.chapterCompletion[i] === true) {
                              adjustedCompletion[i] = true;
                         }
                    }
                    parsed.chapterCompletion = adjustedCompletion;

                    parsed.chapterPages = parsed.chapterPages || [];
                    const adjustedPages = new Array(parsed.totalChapters).fill(0);
                     for(let i=0; i<parsed.totalChapters; i++){
                         adjustedPages[i] = (parsed.chapterPages[i] !== undefined && parsed.chapterPages[i] !== null) ? parsed.chapterPages[i] : 0;
                     }
                    parsed.chapterPages = adjustedPages;

                    return { ...defaults, ...parsed };
                }
                return defaults;
            }

            function saveTrackerData(itemId) {
                const trackerSection = document.querySelector(`.tracker-section[data-item-id="${itemId}"]`);
                if (!trackerSection) return;
                const completionCheckbox = document.getElementById(`done-${itemId}`);

                if (completionCheckbox && completionCheckbox.disabled) return;

                const isSubjectComplete = completionCheckbox ? completionCheckbox.checked : false;
                const totalChaptersInput = trackerSection.querySelector('.tracker-total-chapters');
                const totalChapters = totalChaptersInput ? parseInt(totalChaptersInput.value, 10) || 0 : 0;

                const chapterPageInputs = trackerSection.querySelectorAll('.chapter-page-input');
                const chapterPages = new Array(totalChapters).fill(0);
                 Array.from(chapterPageInputs).forEach((input, index) => {
                    if (index < totalChapters) {
                        chapterPages[index] = parseInt(input.value, 10) || 0;
                    }
                 });

                const chapterCheckboxes = trackerSection.querySelectorAll('.chapter-completion-checkbox');
                 const chapterCompletion = new Array(totalChapters).fill(false);
                  Array.from(chapterCheckboxes).forEach((checkbox, index) => {
                     if (index < totalChapters) {
                         chapterCompletion[index] = checkbox.checked;
                     }
                  });

                const finalChapterCompletion = isSubjectComplete ? new Array(totalChapters).fill(true) : chapterCompletion;

                const data = { isComplete: isSubjectComplete, totalChapters, chapterPages, chapterCompletion: finalChapterCompletion };
                localStorage.setItem(`tracker_${itemId}`, JSON.stringify(data));
            }

            function forceSaveCompletion(itemId) {
                const data = loadTrackerData(itemId);
                if (!data.isComplete) {
                    data.isComplete = true;
                    data.chapterCompletion = new Array(data.totalChapters).fill(true);
                    localStorage.setItem(`tracker_${itemId}`, JSON.stringify(data));
                }
            }

            // --- MODIFIED: Global Progress Update (Based on SUBJECT completion) ---
             function updateGlobalProgress() {
                const subjects = scheduleData[viewState.currentScheduleKey];
                if (!subjects) {
                     globalProgressBar.style.width = `0%`;
                     globalProgressBar.textContent = `0%`;
                     globalSummaryText.textContent = `Select year/spec first.`;
                     return;
                 }

                if (subjects.length === 0) {
                    globalProgressBar.style.width = `0%`;
                    globalProgressBar.textContent = `0%`;
                    globalSummaryText.textContent = `No subjects found for this selection.`;
                    return;
                }

                let completedCount = 0;
                const totalSubjects = subjects.length;

                subjects.forEach(item => {
                    const data = loadTrackerData(item.id);
                    if (data.isComplete) {
                        completedCount++;
                    }
                });

                let progressPercent = 0;
                if (totalSubjects > 0) {
                    progressPercent = Math.round((completedCount / totalSubjects) * 100);
                }

                globalProgressBar.style.width = `${progressPercent}%`;
                globalProgressBar.textContent = `${progressPercent}%`;
                globalSummaryText.textContent = `You have completed ${completedCount} of ${totalSubjects} subjects.`;
            }

            // --- Live Countdown Functions ---
            function startLiveCountdowns() {
                stopLiveCountdowns();
                updateAllCountdowns();
                countdownInterval = setInterval(updateAllCountdowns, 1000);
             }
            function stopLiveCountdowns() {
                if (countdownInterval) clearInterval(countdownInterval);
                 countdownInterval = null;
            }

            function checkAndDisableIfPastDue(countdownElement, distance) {
                 const card = countdownElement.closest('.schedule-item');
                if (!card) return;

                const itemId = card.querySelector('.tracker-section').dataset.itemId;

                if (distance < 0) {
                    if (!card.classList.contains('past-due')) {
                        countdownElement.textContent = "Exam has passed.";
                        card.classList.remove('completed');
                        card.classList.add('past-due');

                        const checkbox = card.querySelector('.completion-tracker input[type="checkbox"]');
                        if (checkbox) {
                            checkbox.checked = true;
                            checkbox.disabled = true;
                        }

                        card.querySelectorAll('.btn-reminder, .btn-tracker-save, .tracker-total-chapters, .chapter-page-input, .chapter-completion-checkbox')
                            .forEach(el => el.disabled = true);

                        forceSaveCompletion(itemId);
                        updateGlobalProgress();
                    }
                } else {
                     if (card.classList.contains('past-due')) {
                          card.classList.remove('past-due');
                           const checkbox = card.querySelector('.completion-tracker input[type="checkbox"]');
                           if(checkbox) checkbox.disabled = false;
                           card.querySelectorAll('.btn-reminder, .btn-tracker-save, .tracker-total-chapters, .chapter-page-input, .chapter-completion-checkbox')
                           .forEach(el => el.disabled = false);
                            saveTrackerData(itemId);
                            updateGlobalProgress();
                     }
                }
             }
            function updateAllCountdowns() {
                const countdownElements = document.querySelectorAll('#schedule-list .countdown-timer');
                const now = new Date().getTime();
                countdownElements.forEach(el => {
                    const eventTime = new Date(el.dataset.datetime).getTime();
                    const distance = eventTime - now;

                    checkAndDisableIfPastDue(el, distance);

                    if (distance >= 0 && !el.closest('.schedule-item')?.classList.contains('past-due')) {
                        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        el.textContent = `Time left: ${days}d ${hours}h ${minutes}m ${seconds}s`;
                    } else if (distance < 0 && !el.closest('.schedule-item')?.classList.contains('past-due')) {
                         el.textContent = "Exam has passed.";
                    }
                });
             }

            // --- Study Timer Logic ---
            pomodoroStartBtn.addEventListener('click', startPomodoro);
            pomodoroPauseBtn.addEventListener('click', pausePomodoro);
            pomodoroResetBtn.addEventListener('click', resetPomodoro);
            pomodoroTimeInput.addEventListener('input', updateTimerFromInput);

            function updateTimerFromInput() {
                 if (isPomodoroRunning) return;
                let minutes = parseInt(pomodoroTimeInput.value, 10) || 0;
                 const minTime = 1;
                const maxTime = 600;
                if (minutes > maxTime) {
                    minutes = maxTime;
                    pomodoroTimeInput.value = maxTime;
                    showToast(`Maximum time is ${maxTime} minutes (10 hours).`, 'error');
                }

                 if (minutes < minTime) {
                    minutes = minTime;
                     if (parseInt(pomodoroTimeInput.value, 10) < minTime) {
                          pomodoroTimeInput.value = minTime;
                     }
                }

                pomodoroTimeLeft = minutes * 60;
                pomodoroInitialTime = pomodoroTimeLeft;
                updatePomodoroDisplay();
             }
            function startPomodoro() {
                 if (isPomodoroRunning) return;

                const subject = pomodoroSubjectSelect.value;
                if (!subject) {
                    showToast("Please select a subject to study first.", 'error');
                    return;
                }

                 const minutes = parseInt(pomodoroTimeInput.value, 10) || 0;
                 const minTime = 1;
                 const maxTime = 600;

                 if (minutes < minTime || minutes > maxTime) {
                     showToast(`Please enter a time between ${minTime} and ${maxTime} minutes.`, 'error');
                     return;
                 }

                pomodoroTimeLeft = minutes * 60;
                pomodoroInitialTime = pomodoroTimeLeft;

                isPomodoroRunning = true;
                pomodoroStartBtn.style.display = 'none';
                pomodoroPauseBtn.style.display = 'inline-block';
                pomodoroTimeInput.disabled = true;
                pomodoroSubjectSelect.disabled = true;

                updatePomodoroDisplay();
                pomodoroInterval = setInterval(updatePomodoro, 1000);
            }
            function pausePomodoro() {
                clearInterval(pomodoroInterval);
                 pomodoroInterval = null;
                isPomodoroRunning = false;
                pomodoroStartBtn.style.display = 'inline-block';
                pomodoroPauseBtn.style.display = 'none';
             }
            function resetPomodoro() {
                pausePomodoro();
                 updateTimerFromInput();
                 pomodoroTimeInput.disabled = false;
                 pomodoroSubjectSelect.disabled = false;
             }
            function updatePomodoro() {
                 pomodoroTimeLeft--;

                if (pomodoroTimeLeft < 0) {
                    clearInterval(pomodoroInterval);
                    pomodoroInterval = null;
                    isPomodoroRunning = false;

                    const subject = pomodoroSubjectSelect.value;
                    const durationInMinutes = Math.round(pomodoroInitialTime / 60);

                    logStudySession(subject, durationInMinutes);

                    showToast(`Session for ${subject} finished! (${durationInMinutes} mins logged)`, 'success');

                    pomodoroStartBtn.style.display = 'inline-block';
                    pomodoroPauseBtn.style.display = 'none';
                    pomodoroTimeInput.disabled = false;
                    pomodoroSubjectSelect.disabled = false;

                    updateTimerFromInput();
                     updatePomodoroDisplay();
                } else {
                    updatePomodoroDisplay();
                }
             }
            function updatePomodoroDisplay() {
                 const m = Math.floor(pomodoroTimeLeft / 60);
                 const s = pomodoroTimeLeft % 60;
                 pomodoroTimerDisplay.textContent = `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
             }

            // --- Statistics Log Functions ---
            function getStudyLogs() {
                 return JSON.parse(localStorage.getItem('studyLogs') || '[]');
            }
            function saveStudyLogs(logs) {
                 localStorage.setItem('studyLogs', JSON.stringify(logs));
             }
            function logStudySession(subject, durationMinutes) {
                 if (!subject || durationMinutes <= 0) return;
                const logs = getStudyLogs();
                logs.push({
                    id: Date.now(),
                    subject: subject,
                    duration: durationMinutes,
                    date: new Date().toISOString()
                });
                saveStudyLogs(logs);
            }
            function displayStudyStats() {
                 const logs = getStudyLogs();
                let summary = {};
                let totalTime = 0;

                statsLogEl.innerHTML = '';

                if (logs.length === 0) {
                    statsSummaryEl.innerHTML = '<h3>Summary by Subject</h3><p>No study sessions logged yet.</p>';
                    statsLogEl.innerHTML = '<p>No log entries.</p>';
                    return;
                }

                logs.slice().reverse().forEach(log => {
                    summary[log.subject] = (summary[log.subject] || 0) + log.duration;
                    totalTime += log.duration;

                    const logDate = new Date(log.date);
                    const logEl = document.createElement('div');
                    logEl.className = 'stat-item';
                    logEl.innerHTML = `
                        <div class="stat-item-info">
                            <strong>${log.subject}</strong> - ${log.duration} mins
                            <span>${logDate.toLocaleString('en-US')}</span>
                        </div>
                        <button class="delete-stat-btn" data-id="${log.id}">&times;</button>
                    `;
                    statsLogEl.appendChild(logEl);
                });

                let summaryHtml = '<h3>Summary by Subject</h3>';
                for (const subject in summary) {
                    const hours = (summary[subject] / 60).toFixed(1);
                    summaryHtml += `<p><strong>${subject}:</strong> ${summary[subject]} minutes (${hours} hours)</p>`;
                }
                summaryHtml += `<hr><p><strong>Total Time:</strong> ${totalTime} minutes (${(totalTime / 60).toFixed(1)} hours)</p>`;
                statsSummaryEl.innerHTML = summaryHtml;
             }
            statsListContainer.addEventListener('click', (e) => {
                 if (e.target.matches('.delete-stat-btn')) {
                    const logId = Number(e.target.dataset.id);
                    let logs = getStudyLogs();
                    logs = logs.filter(log => log.id !== logId);
                    saveStudyLogs(logs);
                    displayStudyStats();
                }
                if (e.target.matches('#delete-all-stats-btn')) {
                    if (confirm("Are you sure you want to delete ALL study statistics? This cannot be undone.")) {
                        saveStudyLogs([]);
                        displayStudyStats();
                        showToast("All stats deleted.", 'info');
                    }
                }
             });

            // --- Helper function to get local date string ---
            function getLocalDateString(date) {
                const y = date.getFullYear();
                 const m = (date.getMonth() + 1).toString().padStart(2, '0');
                 const d = date.getDate().toString().padStart(2, '0');
                 return `${y}-${m}-${d}`;
            }

            // --- Helper function to format hours into hours and minutes ---
             function formatHoursMinutes(decimalHours) {
                const totalMinutes = Math.round(decimalHours * 60);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                let result = '';
                if (hours > 0) {
                    result += `${hours} hour${hours > 1 ? 's' : ''}`;
                }
                if (minutes > 0) {
                    if (hours > 0) result += ' and ';
                    result += `${minutes} minute${minutes > 1 ? 's' : ''}`;
                }
                 if (result === '') return '0 minutes';
                return result;
            }

            // --- The Smart Daily Plan Generator (MODIFIED) ---
            function generateDailyStudyPlan() {
                // Read and validate input hours
                const hoursPerDay = parseInt(hoursPerDayInput.value, 10);
                const MIN_HOURS = 2;
                const MAX_HOURS = 12;

                if (!hoursPerDay || hoursPerDay < MIN_HOURS || hoursPerDay > MAX_HOURS) {
                    planOutput.innerHTML = `<p class="warning">Please enter a valid number of hours (between ${MIN_HOURS} and ${MAX_HOURS}).</p>`;
                    return;
                }

                const subjects = scheduleData[viewState.currentScheduleKey];
                if (!subjects) {
                    planOutput.innerHTML = '<p class="warning">No subjects found for the current selection.</p>';
                    return;
                }

                const now = new Date();
                now.setHours(0, 0, 0, 0);

                // --- Calculate total remaining pages and prepare subjects ---
                let totalRemainingPages = 0;
                let subjectsWithRemaining = [];
                let latestExamDate = new Date(0);
                let hasAtLeastOnePageEntered = false;

                subjects.forEach(item => {
                    const data = loadTrackerData(item.id);

                    // Skip subject if marked complete or exam date is past
                    if (data.isComplete || new Date(item.dateTime) <= now) {
                        return;
                    }

                    let subjectRemainingPages = 0;
                    let chapterDetails = [];
                    let subjectHasPages = false;
                    for (let i = 0; i < data.totalChapters; i++) {
                        // Only consider chapters that are NOT marked complete
                        if (!data.chapterCompletion[i]) {
                            const pagesInChapter = data.chapterPages[i] || 0;
                            if (pagesInChapter > 0) {
                                subjectRemainingPages += pagesInChapter;
                                chapterDetails.push({
                                    chapterIndex: i,
                                    pages: pagesInChapter,
                                    pagesRemainingForAllocation: pagesInChapter
                                });
                                subjectHasPages = true;
                                hasAtLeastOnePageEntered = true;
                            }
                        }
                    }

                    // Add subject to list if it has remaining pages in incomplete chapters
                    if (subjectRemainingPages > 0) {
                        totalRemainingPages += subjectRemainingPages;
                        subjectsWithRemaining.push({
                            ...item,
                            remainingPagesOverall: subjectRemainingPages,
                            chaptersToStudy: chapterDetails
                        });
                        // Update latest exam date
                        if (new Date(item.dateTime) > latestExamDate) {
                            latestExamDate = new Date(item.dateTime);
                        }
                    } else if (data.totalChapters > 0 && !subjectHasPages && !data.isComplete){
                         if (new Date(item.dateTime) > latestExamDate) {
                              latestExamDate = new Date(item.dateTime);
                         }
                    }
                });

                // --- Handle edge cases ---
                if (!hasAtLeastOnePageEntered && subjects.some(s => !loadTrackerData(s.id).isComplete && new Date(s.dateTime) > now)) {
                     planOutput.innerHTML = '<p class="warning">Please add chapters and page counts for at least one subject to generate a plan.</p>';
                     return;
                 }

                if (subjectsWithRemaining.length === 0) {
                    planOutput.innerHTML = '<h3>Congratulations! 🎉</h3><p class="success">You have completed all chapters/pages for upcoming exams!</p>';
                    return;
                }

                if (totalRemainingPages === 0) {
                   planOutput.innerHTML = '<h3>Plan Ready!</h3><p class="success">All remaining subjects have 0 pages in their incomplete chapters. Mark chapters/subjects as done or add page counts.</p>';
                   return;
               }

                subjectsWithRemaining.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

                const dayBeforeLastExam = new Date(latestExamDate);
                dayBeforeLastExam.setDate(dayBeforeLastExam.getDate() - 1);
                const totalAvailableDays = Math.max(1, Math.ceil((dayBeforeLastExam.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)) + 1);

                // --- Calculate Minimum Required Hours & Provide Suggestion ---
                const minRequiredHoursRaw = totalRemainingPages / (DEFAULT_PAGES_PER_HOUR * totalAvailableDays);
                const minRequiredHours = Math.max(MIN_HOURS, Math.min(MAX_HOURS, Math.ceil(minRequiredHoursRaw)));

                let suggestionHtml = '';
                if (hoursPerDay < minRequiredHoursRaw && totalAvailableDays > 0) {
                    suggestionHtml = `<p class="warning"><strong>Suggestion:</strong> Your current ${hoursPerDay} hours/day might be low. To finish comfortably (~${DEFAULT_PAGES_PER_HOUR} pages/hour), consider studying around <strong>${minRequiredHours} hours/day</strong>.</p>`;
                }

                // --- Calculate Effective Daily Page Capacity ---
                 let actualPacePagesPerHour = DEFAULT_PAGES_PER_HOUR;
                 if (hoursPerDay > 0 && totalAvailableDays > 0) {
                    actualPacePagesPerHour = Math.max(DEFAULT_PAGES_PER_HOUR, totalRemainingPages / (hoursPerDay * totalAvailableDays));
                 }
                const dailyPageCapacity = Math.floor(hoursPerDay * actualPacePagesPerHour);

                 if (dailyPageCapacity <=0 && totalRemainingPages > 0) {
                     planOutput.innerHTML = `<p class="warning">Cannot generate plan. The calculated daily page capacity is zero or negative. Check exam dates and study hours.</p>${suggestionHtml}`;
                     return;
                }

                // --- Initialize Daily Plan Map ---
                let dailyPlan = new Map();
                let dayIteratorInit = new Date(now);
                while (dayIteratorInit <= dayBeforeLastExam) {
                    const dateString = getLocalDateString(dayIteratorInit);
                    dailyPlan.set(dateString, { tasks: [], pagesLeftToday: dailyPageCapacity });
                    dayIteratorInit.setDate(dayIteratorInit.getDate() + 1);
                }

                // --- Allocation Logic ---
                let pagesStillToAllocateOverall = totalRemainingPages;
                const MAX_SUBJECTS_PER_DAY = 2;

                const sortedDays = Array.from(dailyPlan.keys()).sort();

                for (const dateString of sortedDays) {
                    const dayPlanData = dailyPlan.get(dateString);
                    const currentDate = new Date(dateString.split('-')[0], dateString.split('-')[1] - 1, dateString.split('-')[2]);

                    for (const subject of subjectsWithRemaining) {
                        if (dayPlanData.pagesLeftToday <= 0 || dayPlanData.tasks.length >= MAX_SUBJECTS_PER_DAY) {
                            break;
                        }
                        if (subject.remainingPagesOverall <= 0) {
                            continue;
                        }
                        const subjectDeadline = new Date(subject.dateTime);
                        subjectDeadline.setDate(subjectDeadline.getDate() - 1);
                        subjectDeadline.setHours(0,0,0,0);
                        if (currentDate > subjectDeadline) {
                            continue;
                        }

                        for (const chapter of subject.chaptersToStudy) {
                            if (chapter.pagesRemainingForAllocation > 0 && dayPlanData.pagesLeftToday > 0) {
                                const existingTaskIndex = dayPlanData.tasks.findIndex(t => t.subject === subject.subjectName);
                                if (existingTaskIndex === -1 && dayPlanData.tasks.length >= MAX_SUBJECTS_PER_DAY) {
                                     continue;
                                }

                                const pagesToAllocateThisSession = Math.min(
                                    chapter.pagesRemainingForAllocation,
                                    dayPlanData.pagesLeftToday
                                );

                                if (existingTaskIndex !== -1) {
                                    let chapterTask = dayPlanData.tasks[existingTaskIndex].details.find(d => d.chapter === chapter.chapterIndex + 1);
                                    if (chapterTask) {
                                        chapterTask.pages += pagesToAllocateThisSession;
                                    } else {
                                        dayPlanData.tasks[existingTaskIndex].details.push({ chapter: chapter.chapterIndex + 1, pages: pagesToAllocateThisSession });
                                    }
                                     dayPlanData.tasks[existingTaskIndex].totalPages += pagesToAllocateThisSession;
                                } else {
                                    dayPlanData.tasks.push({
                                        subject: subject.subjectName,
                                        totalPages: pagesToAllocateThisSession,
                                        details: [{ chapter: chapter.chapterIndex + 1, pages: pagesToAllocateThisSession }]
                                    });
                                }

                                dayPlanData.pagesLeftToday -= pagesToAllocateThisSession;
                                chapter.pagesRemainingForAllocation -= pagesToAllocateThisSession;
                                subject.remainingPagesOverall -= pagesToAllocateThisSession;
                                pagesStillToAllocateOverall -= pagesToAllocateThisSession;

                                if (dayPlanData.pagesLeftToday <= 0) {
                                    break;
                                }
                                if (chapter.pagesRemainingForAllocation <= 0) {
                                    continue;
                                }
                                break;
                            }
                        }

                        if (dayPlanData.pagesLeftToday <= 0 || dayPlanData.tasks.length >= MAX_SUBJECTS_PER_DAY) {
                            break;
                        }
                    }
                }

                // --- Generate HTML Output ---
                let outputHtml = `<h3>Your Daily Plan (${hoursPerDay} hours/day)</h3>`;
                outputHtml += suggestionHtml;
                outputHtml += `<p>Calculated daily goal: ~<strong>${dailyPageCapacity} pages</strong>.</p>
                               <p class="plan-note">Plan prioritizes earlier deadlines. Max ${MAX_SUBJECTS_PER_DAY} subjects per day. Only includes pages from incomplete chapters.</p>`;

                 if (pagesStillToAllocateOverall > 0.1) {
                     outputHtml += `<p class="warning"><strong>Warning:</strong> Could not allocate all pages (${Math.ceil(pagesStillToAllocateOverall)} remaining). Your schedule might be too tight. Please review chapters, page counts, and consider increasing daily study hours (suggested: ${minRequiredHours} hours/day).</p>`;
                 } else if (totalRemainingPages > 0 ) {
                     outputHtml += `<p class="success">Great! This plan helps you cover all remaining pages. Stick to it! 💪</p>`;
                 }

                let planHasTasks = false;

                sortedDays.forEach(dateString => {
                    const { tasks } = dailyPlan.get(dateString);
                    if (tasks.length > 0) {
                        planHasTasks = true;
                        const parts = dateString.split('-');
                        const displayDate = new Date(parts[0], parts[1] - 1, parts[2]);
                        const dateLocale = displayDate.toLocaleString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

                        outputHtml += `<div class="plan-day-group"><h3>${dateLocale}</h3><ul>`;

                        tasks.forEach(task => {
                             const chapterDetailsString = task.details.map(d => `Ch ${d.chapter} (${Math.round(d.pages)}p)`).join(', ');
                             const totalHoursDecimal = task.totalPages / actualPacePagesPerHour;
                             const timeString = formatHoursMinutes(totalHoursDecimal);

                             outputHtml += `
                                <li>
                                    <strong>${task.subject}</strong>: ${chapterDetailsString} (${Math.round(task.totalPages)} pages total)
                                    <span>Approx. ${timeString}</span>
                                </li>`;
                        });

                        outputHtml += `</ul></div>`;
                    }
                });

                 if (!planHasTasks && pagesStillToAllocateOverall <= 0.1 && totalRemainingPages > 0) {
                    outputHtml += '<p>No specific tasks scheduled for the upcoming days. This might happen if remaining pages are very few or spread out far in the future.</p>';
                } else if (!planHasTasks && pagesStillToAllocateOverall > 0.1) {
                     outputHtml += '<p class="warning">Could not schedule any tasks. Please check your inputs and deadlines.</p>';
                }

                planOutput.innerHTML = outputHtml;
                
                // Show save section after generating plan
                planSaveSection.style.display = 'block';
            }

            // --- Saved Plans Functions ---
            showSavedPlansBtn.addEventListener('click', () => {
                displaySavedPlans();
                savedPlansModal.style.display = 'flex';
            });
            
            closeSavedPlansModalBtn.addEventListener('click', () => savedPlansModal.style.display = 'none');
            savedPlansModal.addEventListener('click', (e) => {
                if (e.target === savedPlansModal) savedPlansModal.style.display = 'none';
            });
            
            deleteAllPlansBtn.addEventListener('click', deleteAllSavedPlans);
            savePlanBtn.addEventListener('click', saveCurrentPlan);

            function getSavedPlans() {
                return JSON.parse(localStorage.getItem('savedPlans') || '[]');
            }

            function savePlansToStorage(plans) {
                localStorage.setItem('savedPlans', JSON.stringify(plans));
            }

            function saveCurrentPlan() {
                const planContent = document.getElementById('plan-output').innerHTML;
                const planName = planNameInput.value.trim() || `Study Plan ${new Date().toLocaleDateString()}`;
                const hoursPerDay = document.getElementById('hours-per-day').value;
                
                if (!planContent || planContent.includes('Enter your daily hours')) {
                    showToast('Please generate a plan first before saving.', 'error');
                    return;
                }
                
                const plans = getSavedPlans();
                const newPlan = {
                    id: Date.now(),
                    name: planName,
                    content: planContent,
                    hoursPerDay: hoursPerDay,
                    dateCreated: new Date().toISOString(),
                    completed: false,
                    daysCompleted: {} // سيتم تخزين حالة إنجاز كل يوم هنا
                };
                
                plans.unshift(newPlan);
                savePlansToStorage(plans);
                
                showToast(`Plan "${planName}" saved successfully!`, 'success');
                planModal.style.display = 'none';
            }

            function displaySavedPlans() {
                const plans = getSavedPlans();
                savedPlansList.innerHTML = '';
                
                if (plans.length === 0) {
                    savedPlansList.innerHTML = '<div class="no-plans-message">You have no saved plans yet.</div>';
                    return;
                }
                
                plans.forEach(plan => {
                    const planElement = document.createElement('div');
                    planElement.className = `saved-plan-item ${plan.completed ? 'completed' : ''}`;
                    
                    // استخراج الأيام من محتوى الخطة
                    const daysContent = extractDaysFromPlan(plan.content);
                    
                    planElement.innerHTML = `
                        <div class="saved-plan-header">
                            <div>
                                <h3 class="saved-plan-title">${plan.name}</h3>
                                <div class="saved-plan-date">Created: ${new Date(plan.dateCreated).toLocaleDateString()} | Hours/Day: ${plan.hoursPerDay}</div>
                            </div>
                            <div class="saved-plan-actions">
                                <button class="btn btn-delete delete-plan-btn" data-plan-id="${plan.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="saved-plan-content">
                            ${plan.content}
                        </div>
                        <div class="saved-plan-days" id="days-container-${plan.id}">
                            ${generateDaysHTML(plan.id, daysContent, plan.daysCompleted)}
                        </div>
                        <div class="plan-completion-toggle">
                            <input type="checkbox" id="plan-complete-${plan.id}" class="plan-completion-checkbox" ${plan.completed ? 'checked' : ''}>
                            <label for="plan-complete-${plan.id}">Mark this plan as completed</label>
                        </div>
                        <button class="btn complete-all-days-btn" data-plan-id="${plan.id}">
                            <i class="fas fa-check-double"></i> Mark All Days as Completed
                        </button>
                    `;
                    
                    savedPlansList.appendChild(planElement);
                    
                    // إضافة مستمعي الأحداث
                    const deleteBtn = planElement.querySelector('.delete-plan-btn');
                    deleteBtn.addEventListener('click', () => deleteSavedPlan(plan.id));
                    
                    const completionCheckbox = planElement.querySelector('.plan-completion-checkbox');
                    completionCheckbox.addEventListener('change', () => togglePlanCompletion(plan.id, completionCheckbox.checked));
                    
                    const completeAllBtn = planElement.querySelector('.complete-all-days-btn');
                    completeAllBtn.addEventListener('click', () => completeAllDays(plan.id));
                    
                    // إضافة مستمعي الأحداث لمربعات اختيار الأيام
                    const dayCheckboxes = planElement.querySelectorAll('.day-completion-checkbox');
                    dayCheckboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', (e) => {
                            const dayIndex = e.target.dataset.dayIndex;
                            toggleDayCompletion(plan.id, dayIndex, e.target.checked);
                        });
                    });
                    
                    // إضافة مستمعي الأحداث لمهام الأيام
                    const taskCheckboxes = planElement.querySelectorAll('.task-completion-checkbox');
                    taskCheckboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', (e) => {
                            const dayIndex = e.target.dataset.dayIndex;
                            const taskIndex = e.target.dataset.taskIndex;
                            toggleTaskCompletion(plan.id, dayIndex, taskIndex, e.target.checked);
                        });
                    });
                });
            }

            // دالة استخراج الأيام من محتوى الخطة
            function extractDaysFromPlan(planContent) {
                const days = [];
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = planContent;
                
                const dayGroups = tempDiv.querySelectorAll('.plan-day-group');
                dayGroups.forEach((dayGroup, index) => {
                    const dayTitle = dayGroup.querySelector('h3').textContent;
                    const tasks = [];
                    
                    const taskItems = dayGroup.querySelectorAll('li');
                    taskItems.forEach((taskItem, taskIndex) => {
                        tasks.push({
                            index: taskIndex,
                            content: taskItem.innerHTML,
                            completed: false
                        });
                    });
                    
                    days.push({
                        index: index,
                        title: dayTitle,
                        tasks: tasks,
                        completed: false
                    });
                });
                
                return days;
            }

            // دالة إنشاء HTML للأيام
            function generateDaysHTML(planId, days, daysCompleted = {}) {
                if (days.length === 0) return '';
                
                let daysHTML = '<h4 style="margin-top: 1.5rem; margin-bottom: 1rem; color: var(--primary-blue);"><i class="fas fa-calendar-day"></i> Daily Progress</h4>';
                
                days.forEach((day, index) => {
                    const isDayCompleted = daysCompleted[day.index]?.completed || false;
                    const dayTasksCompleted = daysCompleted[day.index]?.tasks || {};
                    
                    daysHTML += `
                        <div class="saved-plan-day ${isDayCompleted ? 'completed' : ''}" id="day-${planId}-${day.index}">
                            <div class="saved-plan-day-header">
                                <h4 class="saved-plan-day-title">${day.title}</h4>
                                <div class="day-completion-toggle">
                                    <input type="checkbox" id="day-complete-${planId}-${day.index}" 
                                           class="day-completion-checkbox" 
                                           data-day-index="${day.index}"
                                           ${isDayCompleted ? 'checked' : ''}>
                                    <label for="day-complete-${planId}-${day.index}">Day Completed</label>
                                </div>
                            </div>
                            <div class="saved-plan-day-tasks">
                                ${generateTasksHTML(planId, day.index, day.tasks, dayTasksCompleted)}
                            </div>
                        </div>
                    `;
                });
                
                return daysHTML;
            }

            // دالة إنشاء HTML للمهام
            function generateTasksHTML(planId, dayIndex, tasks, tasksCompleted = {}) {
                if (tasks.length === 0) return '';
                
                let tasksHTML = '';
                tasks.forEach((task, taskIndex) => {
                    const isTaskCompleted = tasksCompleted[taskIndex] || false;
                    
                    tasksHTML += `
                        <div class="saved-plan-day-task ${isTaskCompleted ? 'completed' : ''}">
                            <input type="checkbox" id="task-${planId}-${dayIndex}-${taskIndex}" 
                                   class="task-completion-checkbox"
                                   data-day-index="${dayIndex}"
                                   data-task-index="${taskIndex}"
                                   ${isTaskCompleted ? 'checked' : ''}>
                            <label for="task-${planId}-${dayIndex}-${taskIndex}">${task.content}</label>
                        </div>
                    `;
                });
                
                return tasksHTML;
            }

            // دالة تبديل إنجاز اليوم
            function toggleDayCompletion(planId, dayIndex, isCompleted) {
                const plans = getSavedPlans();
                const planIndex = plans.findIndex(plan => plan.id === parseInt(planId));
                
                if (planIndex !== -1) {
                    // تهيئة daysCompleted إذا لم تكن موجودة
                    if (!plans[planIndex].daysCompleted) {
                        plans[planIndex].daysCompleted = {};
                    }
                    
                    // تهيئة اليوم إذا لم يكن موجوداً
                    if (!plans[planIndex].daysCompleted[dayIndex]) {
                        plans[planIndex].daysCompleted[dayIndex] = {
                            completed: false,
                            tasks: {}
                        };
                    }
                    
                    // تحديث حالة إنجاز اليوم
                    plans[planIndex].daysCompleted[dayIndex].completed = isCompleted;
                    
                    // إذا تم تحديد إنجاز اليوم، حدد جميع مهامه
                    if (isCompleted) {
                        const dayElement = document.getElementById(`day-${planId}-${dayIndex}`);
                        if (dayElement) {
                            const taskCheckboxes = dayElement.querySelectorAll('.task-completion-checkbox');
                            taskCheckboxes.forEach(checkbox => {
                                checkbox.checked = true;
                                const taskIndex = checkbox.dataset.taskIndex;
                                plans[planIndex].daysCompleted[dayIndex].tasks[taskIndex] = true;
                            });
                        }
                    }
                    
                    savePlansToStorage(plans);
                    
                    // التحقق مما إذا كانت جميع الأيام مكتملة لتحديد إنجاز الخطة
                    checkAndUpdatePlanCompletion(planId);
                    
                    showToast(`Day ${parseInt(dayIndex) + 1} ${isCompleted ? 'marked as completed' : 'marked as not completed'}.`, 'success');
                }
            }

            // دالة تبديل إنجاز المهمة
            function toggleTaskCompletion(planId, dayIndex, taskIndex, isCompleted) {
                const plans = getSavedPlans();
                const planIndex = plans.findIndex(plan => plan.id === parseInt(planId));
                
                if (planIndex !== -1) {
                    // تهيئة daysCompleted إذا لم تكن موجودة
                    if (!plans[planIndex].daysCompleted) {
                        plans[planIndex].daysCompleted = {};
                    }
                    
                    // تهيئة اليوم إذا لم يكن موجوداً
                    if (!plans[planIndex].daysCompleted[dayIndex]) {
                        plans[planIndex].daysCompleted[dayIndex] = {
                            completed: false,
                            tasks: {}
                        };
                    }
                    
                    // تحديث حالة إنجاز المهمة
                    plans[planIndex].daysCompleted[dayIndex].tasks[taskIndex] = isCompleted;
                    
                    // التحقق مما إذا كانت جميع مهام اليوم مكتملة لتحديد إنجاز اليوم
                    const dayElement = document.getElementById(`day-${planId}-${dayIndex}`);
                    if (dayElement) {
                        const taskCheckboxes = dayElement.querySelectorAll('.task-completion-checkbox');
                        const allTasksCompleted = Array.from(taskCheckboxes).every(checkbox => checkbox.checked);
                        
                        if (allTasksCompleted) {
                            const dayCheckbox = dayElement.querySelector('.day-completion-checkbox');
                            if (dayCheckbox && !dayCheckbox.checked) {
                                dayCheckbox.checked = true;
                                plans[planIndex].daysCompleted[dayIndex].completed = true;
                            }
                        } else {
                            const dayCheckbox = dayElement.querySelector('.day-completion-checkbox');
                            if (dayCheckbox && dayCheckbox.checked) {
                                dayCheckbox.checked = false;
                                plans[planIndex].daysCompleted[dayIndex].completed = false;
                            }
                        }
                    }
                    
                    savePlansToStorage(plans);
                    
                    // التحقق مما إذا كانت جميع الأيام مكتملة لتحديد إنجاز الخطة
                    checkAndUpdatePlanCompletion(planId);
                    
                    showToast(`Task ${parseInt(taskIndex) + 1} ${isCompleted ? 'marked as completed' : 'marked as not completed'}.`, 'success');
                }
            }

            // دالة إكمال جميع الأيام
            function completeAllDays(planId) {
                const plans = getSavedPlans();
                const planIndex = plans.findIndex(plan => plan.id === parseInt(planId));
                
                if (planIndex !== -1) {
                    // الحصول على جميع عناصر الأيام
                    const dayElements = document.querySelectorAll(`#days-container-${planId} .saved-plan-day`);
                    
                    dayElements.forEach(dayElement => {
                        const dayIndex = dayElement.querySelector('.day-completion-checkbox').dataset.dayIndex;
                        
                        // تحديث حالة اليوم
                        if (!plans[planIndex].daysCompleted) {
                            plans[planIndex].daysCompleted = {};
                        }
                        
                        if (!plans[planIndex].daysCompleted[dayIndex]) {
                            plans[planIndex].daysCompleted[dayIndex] = {
                                completed: true,
                                tasks: {}
                            };
                        } else {
                            plans[planIndex].daysCompleted[dayIndex].completed = true;
                        }
                        
                        // تحديث جميع مهام اليوم
                        const taskCheckboxes = dayElement.querySelectorAll('.task-completion-checkbox');
                        taskCheckboxes.forEach(checkbox => {
                            checkbox.checked = true;
                            const taskIndex = checkbox.dataset.taskIndex;
                            plans[planIndex].daysCompleted[dayIndex].tasks[taskIndex] = true;
                        });
                    });
                    
                    savePlansToStorage(plans);
                    
                    // تحديث واجهة المستخدم
                    displaySavedPlans();
                    
                    showToast('All days marked as completed!', 'success');
                }
            }

            // دالة التحقق وتحديث إنجاز الخطة
            function checkAndUpdatePlanCompletion(planId) {
                const plans = getSavedPlans();
                const planIndex = plans.findIndex(plan => plan.id === parseInt(planId));
                
                if (planIndex !== -1 && plans[planIndex].daysCompleted) {
                    const allDays = Object.values(plans[planIndex].daysCompleted);
                    const allDaysCompleted = allDays.length > 0 && allDays.every(day => day.completed);
                    
                    if (allDaysCompleted && !plans[planIndex].completed) {
                        plans[planIndex].completed = true;
                        savePlansToStorage(plans);
                        
                        const completionCheckbox = document.getElementById(`plan-complete-${planId}`);
                        if (completionCheckbox) {
                            completionCheckbox.checked = true;
                        }
                        
                        showToast('Plan completed! All days are finished!', 'success');
                    }
                }
            }

            // دالة حذف خطة محددة
            function deleteSavedPlan(planId) {
                if (confirm('Are you sure you want to delete this plan?')) {
                    const plans = getSavedPlans();
                    const updatedPlans = plans.filter(plan => plan.id !== parseInt(planId));
                    savePlansToStorage(updatedPlans);
                    displaySavedPlans();
                    showToast('Plan deleted successfully.', 'info');
                }
            }

            // دالة حذف جميع الخطط
            function deleteAllSavedPlans() {
                const plans = getSavedPlans();
                if (plans.length === 0) {
                    showToast('No plans to delete.', 'info');
                    return;
                }
                
                if (confirm('Are you sure you want to delete ALL saved plans? This cannot be undone.')) {
                    savePlansToStorage([]);
                    displaySavedPlans();
                    showToast('All plans deleted.', 'info');
                }
            }

            // دالة تحديد/إلغاء تحديد إنجاز الخطة
            function togglePlanCompletion(planId, isCompleted) {
                const plans = getSavedPlans();
                const planIndex = plans.findIndex(plan => plan.id === parseInt(planId));
                
                if (planIndex !== -1) {
                    plans[planIndex].completed = isCompleted;
                    savePlansToStorage(plans);
                    displaySavedPlans();
                    showToast(`Plan ${isCompleted ? 'marked as completed' : 'marked as not completed'}.`, 'success');
                }
            }

            // --- زر العودة للأعلى ---
            const backToTopBtn = document.getElementById('back-to-top');

            // إظهار/إخفاء زر العودة للأعلى
            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    backToTopBtn.style.display = 'flex';
                } else {
                    backToTopBtn.style.display = 'none';
                }
            });

            // حدث النقر على زر العودة للأعلى
            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });

            // --- Initialize ---
            updateTimerFromInput(); // Initialize timer display on load
        }); // End of DOMContentLoaded
    </script>
</body>

</html>